name: Build Docker Image
on:
  #防止fork乱用action设置只能手动触发构建
  workflow_dispatch:
  ## 发布release的时候会自动构建
  release:
    types: [published]
jobs:
  prepare:
    runs-on: ubuntu-latest
    name: Prepare build metadata
    permissions:
      contents: read
    outputs:
      version: ${{ steps.check_version.outputs.version }}
      is_prerelease: ${{ github.event.release.prerelease }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          persist-credentials: false

      - name: judge has env GITHUB_REF  # 如果没有GITHUB_REF环境变量，则把github.ref变量赋值给GITHUB_REF
        run: |
          if [ -z "$GITHUB_REF" ]; then
            export GITHUB_REF=${{ github.ref }}
            echo $GITHUB_REF
          fi
      - name: Check version
        id: check_version
        run: |
          echo $GITHUB_REF
          # 如果是tag，则去掉refs/tags/前缀
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "It's a tag"
            echo $GITHUB_REF
            echo $GITHUB_REF | awk -F '/' '{print $3}'
            echo ::set-output name=version::$(echo $GITHUB_REF | awk -F '/' '{print $3}')
          else
            echo "It's not a tag"
            echo $GITHUB_REF
            echo ::set-output name=version::${GITHUB_REF}
          fi

  build-images:
    runs-on: ubuntu-latest
    needs: prepare
    name: Build ${{ matrix.platform }} image
    permissions:
      contents: read
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          persist-credentials: false

      - name: Set platform tag
        id: platform_tag
        run: |
          # Convert platform to tag suffix (e.g., linux/amd64 -> amd64)
          PLATFORM_TAG=$(echo ${{ matrix.platform }} | sed 's/linux\///g')
          echo ::set-output name=tag::${PLATFORM_TAG}

      - name: Login to Registry
        run: docker login --username=${{ secrets.DOCKER_USERNAME }} --password ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and push
        run: |
          docker buildx build \
            --platform ${{ matrix.platform }} \
            -t rockchin/langbot:${{ needs.prepare.outputs.version }}-${{ steps.platform_tag.outputs.tag }} \
            . --push

  create-manifest:
    runs-on: ubuntu-latest
    needs: [prepare, build-images]
    name: Create multi-arch manifest
    permissions:
      contents: read
    steps:
      - name: Login to Registry
        run: docker login --username=${{ secrets.DOCKER_USERNAME }} --password ${{ secrets.DOCKER_PASSWORD }}

      - name: Create and push manifest for version tag
        run: |
          docker buildx imagetools create \
            -t rockchin/langbot:${{ needs.prepare.outputs.version }} \
            rockchin/langbot:${{ needs.prepare.outputs.version }}-amd64 \
            rockchin/langbot:${{ needs.prepare.outputs.version }}-arm64

      - name: Create and push manifest for latest tag
        if: ${{ needs.prepare.outputs.is_prerelease == 'false' }}
        run: |
          docker buildx imagetools create \
            -t rockchin/langbot:latest \
            rockchin/langbot:${{ needs.prepare.outputs.version }}-amd64 \
            rockchin/langbot:${{ needs.prepare.outputs.version }}-arm64
